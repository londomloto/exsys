<link rel="import" href="../../elements/kct-view/kct-view.html">
<link rel="import" href="../../elements/kct-ajax/kct-ajax.html">
<link rel="import" href="../../elements/kct-grid/kct-grid.html">
<link rel="import" href="../../elements/kct-pages/kct-pages.html">
<link rel="import" href="tasks-receive-expense.html">
<link rel="import" href="tasks-receive-advance.html">

<dom-module id="tasks-receive-page">
    <template>

        <style include="theme-helper">
            :host {
                height: var(--tasks-receive-page-height, 600px);
            }
            #pages {
                display: block;
                height: 100%;
            }
        </style>
        
        <kct-pages id="pages" selected="{{ page }}" attr-for-selected="id">
            <kct-grid 
                id="grid" 
                url="/finance/tasks?display=receive-request" 
                page-size="25" 
                name="list"
                columns="[[ columns ]]" 
                title="DATASHEET" 
                description="Receive Tasklist" 
                selection-model="cell" 
                pagination 
                autoload>

                <template preserve-content>
                    <style include="theme-helper"></style>
                </template>

            </kct-grid>

            <tasks-receive-expense id="expense" route="{{ route }}" state="[[ state ]]"></tasks-receive-expense>
            <tasks-receive-advance id="advance" route="{{ route }}" state="[[ state ]]"></tasks-receive-advance>
        </kct-pages>

    </template>
    <script>
        class TasksReceivePage extends KctView {
            static get is() {
                return 'tasks-receive-page';
            }
            static get properties() {
                return {
                    title: { type: String, value: 'Receive Tasks', notify: true },
                    page: { type: String, value: 'grid' },
                    columns: { 
                        type: Array,
                        value: [
                            { type: 'rownumber' },
                            { text: 'Document No.', dataIndex: 'ref_no', width: 120, align: 'center' },
                            { text: 'Subject', dataIndex: 'subject' },
                            { text: 'Proposed By', dataIndex: 'user_fullname' },
                            { text: 'Date Created', dataIndex: 'date_short', width: 120, align: 'center' },
                            { 
                                text: 'Amounts (IDR)', 
                                dataIndex: 'amounts', 
                                align: 'right',
                                renderer: (e) => {
                                    return e.data ? e.data.amounts_formatted : '';
                                }
                            },
                            { 
                                text: '',
                                type: 'action',
                                renderer: (e) => {
                                    if (e.data) {
                                        return `<paper-button on-tap="__onViewTap" class="btn-amber">View</paper-button>`;
                                    }
                                    return '';
                                }
                            }
                        ]
                    }
                }
            }
            constructor() {
                super();
            }
            ready() {
                super.ready();
                this.$.grid.context = this;
            }
            handleResizing(width, height) {
                this.updateStyles({'--tasks-receive-page-height': height + 'px'});

                if (this.page == 'grid') {
                    this.$.grid.resize();
                } else {
                    this.$[this.page] && this.$[this.page].handleResizing(width, height);
                }
            }
            handleRouteParams(context, id) {
                if (context) {
                    this.set('page', context);
                } else {
                    this.set('page', 'grid');
                    
                    this.$.grid.deferAutoresize();
                    this.$.grid.load();
                }
            }
            __onViewTap(e) {
                let context = e.data.module;
                this.set('route.path', '/tasks/tasks-receive/' + context + '/' + e.data.id_ref);
            }
            __onActionBackTap() {
                this.set('page', 'grid');
                this.$.grid.load();
            }
        }
        customElements.define(TasksReceivePage.is, TasksReceivePage);
    </script>
</dom-module>