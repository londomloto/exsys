<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="../../../bower_components/paper-radio-button/paper-radio-button.html">
<link rel="import" href="../../../bower_components/vaadin-combo-box/vaadin-combo-box.html">
<link rel="import" href="../../elements/kct-view/kct-view.html">
<link rel="import" href="../../elements/kct-grid/kct-grid.html">
<link rel="import" href="../../elements/kct-ajax/kct-ajax.html">
<link rel="import" href="../../elements/kct-dialog/kct-dialog.html">
<link rel="import" href="../../elements/kct-app/blocks/page-header-block.html">

<dom-module id="products-page">
    <template>
        <style include="theme-helper">
            :host {
                height: var(--products-page-height, 100%);
            }
            
        </style>

        <kct-ajax id="productsAjax1"></kct-ajax>
        <kct-ajax id="productsAjax2"></kct-ajax>

        <kct-grid 
            id="productsGrid" 
            url="/products" 
            page-size="10" 
            row-height="60" 
            columns="{{ columns }}" 
            selected="{{ selectedLead }}" 
            icon="view-quilt" 
            title="Products"  
            description="Available Products" 
            autoload>

            <template preserve-content>
                <style>
                    .cell-customer {
                        @apply --layout-horizontal;
                    }
                    .cell-customer > .logo > span {
                        display: block;
                        width: 40px;
                        height: 40px;
                        color: #fff;
                        text-align: center;
                        font-size: 20px;
                        line-height: 36px;
                        font-weight: 300;
                        border-radius: 50%;
                        margin-right: 8px;
                    }
                    .cell-customer > .text {
                        @apply --layout-flex;
                    }
                </style>
            </template>

            <div slot="grid-toolbar">
                <paper-button on-tap="__onAddTap"><iron-icon icon="add"></iron-icon>&nbsp;Add</paper-button>
                <paper-button on-tap="__onEditTap"><iron-icon icon="done"></iron-icon>&nbsp;Edit</paper-button>
                <paper-button on-tap="__onRemoveTap"><iron-icon icon="clear"></iron-icon>&nbsp;Remove</paper-button>
            </div>

        </kct-grid>

        <kct-dialog id="productsEditor" title="Product Editor" height="100%" width="400">
            <template preserve-content>
                <style>
                    vaadin-combo-box { padding: 2px 0; }
                    .hidden-phantom[hidden] { display: none;  }
                </style>

                <div slot="dialog-body">
                    <vaadin-combo-box 
                        id="combo-products" 
                        label="Services" 
                        value="{{ selectedLead.tp_service }}" 
                        items="[[ services ]]" 
                        item-label-path="tp_service" 
                        item-value-path="tp_service"
                        allow-custom-value>
                        <template>
                            <style>
                                .bold { font-weight: 500; }
                                .nude { color: #999; font-size: 14px;  }
                            </style>
                            <div class="bold">[[ item.tp_service ]]</div>
                        </template>        
                    </vaadin-combo-box>

                    <!-- <div class="hidden-phantom" hidden$="[[ selectedLead.tl_phantom ]]">
                        <vaadin-combo-box 
                            id="combo-customer" 
                            label="Status" 
                            value="{{ selectedLead.tl_status }}" 
                            items="[[ statuses ]]" 
                            item-label-path="text" 
                            item-value-path="name"></vaadin-combo-box>    
                        <paper-input label="Amounts" value="{{ selectedLead.ts_amounts }}"></paper-input>    
                    </div> -->

                   <!--  <paper-input label="Service" value="{{ selectedLead.tp_service }}"></paper-input> -->
                    
                    <paper-input label="Sub Service" value="{{ selectedLead.tp_sub_service }}"></paper-input>
                </div>
                <div slot="dialog-footer">
                    <paper-button on-tap="__onEditorSave">Save</paper-button>
                    <paper-button on-tap="__onEditorClose">Close</paper-button>
                </div>
            </template>
        </kct-dialog>
    </template>
    <script>
        class ProductsPage extends KctView {
            static get is() {
                return 'products-page';
            }
            static get properties() {
                return {
                    title: { type: String, notify: true, value: 'Products' },
                    columns: {
                        type: Array,
                        value: () => ([
                            
                            { text: 'Service', width: 300, dataIndex: 'tp_service'},
                            { text: 'Sub Service', width: 300, dataIndex: 'tp_sub_service' },
                        ])
                    },
                    services: { type: Array },
                    statuses: {
                        type: Array,
                        value: () => ([
                            { text: 'HOT', name: 'HOT' },
                            { text: 'HOLD', name: 'HOLD' },
                            { text: 'DUMP', name: 'DUMP' }
                        ])
                    },
                    selectedLead: { type: Object }
                };
            }
            handleResizing(width, height) {
                this.updateStyles({'--products-page-height': height + 'px'});
                if (this.$.productsGrid) {
                    this.$.productsGrid.resize();
                }
            }
            activate() {
                // this.__loadServices();

                if (this.$.productsGrid) {
                    this.$.productsGrid.resize();
                }
            }
            __loadServices() {
                let ajax = this.$.productsAjax1;
                ajax.GET('/products/services').then(res => {
                    this.set('services', res.data);
                });
            }
            __onAddTap() {
                let data = {
                    tl_mc_id: null,
                    tl_status: '',
                    tl_notes: '',
                    tl_phantom: true
                };

                this.__loadServices();

                this.set('selectedLead', data);
                this.$.productsEditor.open();
            }
            __onEditTap() {
                if ( ! this.selectedLead) {
                    this.toast('Warning', 'No selected record to edit', 'warn');
                    return;
                }

                this.__loadServices();

                this.set('selectedLead.tl_phantom', false);
                this.$.productsEditor.open();
            }
            __onRemoveTap() {
                if ( ! this.selectedLead) {
                    this.toast('Warning', 'No selected record to edit', 'warn');
                    return;
                }

                this.confirm('Confirm', 'Delete selected record?').then(y => {
                    if (y) {
                        let ajax = this.$.productsAjax1;
                        ajax.DELETE('/products/' + this.selectedLead.tp_id).then(() => {
                            this.$.productsGrid.load();
                        });
                    }
                });

            }
            __onEditorClose() {
                this.$.productsEditor.close();
            }
            __onEditorSave() {
                this.$.productsEditor.close();

                let data = this.selectedLead,
                    ajax = this.$.productsAjax2;

                if (data.tp_id) {
                    ajax.PUT('/products/' + data.tp_id, data).then(done.bind(this));
                } else {
                    ajax.POST('/products', data).then(done.bind(this))
                }
                
                function done(res) {
                    if (res.success) {
                        this.$.productsGrid.load();
                    }
                }
            }
        }

        customElements.define(ProductsPage.is, ProductsPage);
    </script>
</dom-module>