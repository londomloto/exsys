<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../elements/kct-view/kct-view.html">
<link rel="import" href="../../elements/kct-ajax/kct-ajax.html">
<link rel="import" href="../../elements/kct-grid/kct-grid.html">

<dom-module id="expense-list-page">
    <template>
        
        <style include="theme-helper">
            :host {
                height: 100%;
            }
        </style>

        <kct-ajax id="ajax"></kct-ajax>

        <kct-grid 
            id="grid" 
            url="/expense?category=expense" 
            page-size="25" 
            columns="[[ columns ]]" 
            title="DATASHEET" 
            description="List of Expense" 
            selection-model="cell" 
            pagination>

                <template preserve-content>
                    <style include="theme-helper">
                    </style>
                </template>

            <paper-button class="btn-primary" slot="primary-toolbar" on-tap="__onAddTap"><iron-icon icon="add"></iron-icon>&nbsp;Expense Request</paper-button>

        </kct-grid>

    </template>
    <script>
        {
            class ExpenseListPage extends KctView {
                static get is() {
                    return 'expense-list-page';
                }
                static get properties() {
                    return {
                        columns: { 
                            type: Array,
                            value: [
                                { type: 'rownumber' },
                                { text: 'Expense No.', dataIndex: 'exp_no', width: 120, align: 'center' },
                                { text: 'Subject', dataIndex: 'subject_exp', width: 300 },
                                { 
                                    text: 'Date Created', 
                                    dataIndex: 'date', 
                                    width: 120,  
                                    align: 'center',
                                    renderer: (e) => {
                                        return e.data ? e.data.date_short : '';
                                    }
                                },
                                { 
                                    text: 'Amounts (IDR)', 
                                    dataIndex: 'amounts', 
                                    align: 'right', 
                                    width: 150,
                                    renderer: (e) => {
                                        return e.data ? e.data.amounts_formatted : '-';
                                    }
                                },
                                { 
                                    text: 'Status', 
                                    dataIndex: 'status_name', 
                                    width: 150,
                                    renderer: (e) => {
                                        if (e.data) {
                                            return `<iron-icon icon="image:lens" style="color: ${e.data.status_color}"></iron-icon>&nbsp;<span>${e.data.status_name}</span>`;
                                        }
                                        return '';
                                    }
                                },
                                { 
                                    text: 'Action',
                                    type: 'action',
                                    renderer: (e) => {
                                        if (e.data) {
                                            let status = e.data.status;
                                            let buttons = `<paper-button on-tap="__onViewTap" class="btn-muted btn-icon" title="View"><iron-icon icon="search"></iron-icon></paper-button>`;

                                            if (e.data.editable) {
                                                buttons += `
                                                    <paper-button on-tap="__onEditTap" class="btn-amber btn-icon" title="Edit"><iron-icon icon="image:edit"></iron-icon></paper-button>
                                                    <paper-button on-tap="__onDeleteTap" class="btn-danger btn-icon" title="Delete"><iron-icon icon="clear"></iron-icon></paper-button>
                                                `;
                                                if (e.data.has_items) {
                                                    buttons += `<paper-button on-tap="__onSubmitTap" class="btn-info btn-icon" title="Submit"><iron-icon icon="done"></iron-icon></paper-button>`;
                                                }
                                            }

                                            if (e.data.status_code == 'fa-approved') {
                                                buttons += `<paper-button on-tap="__onJournalTap" class="btn-muted btn-icon" title="Journal"><iron-icon icon="print"></iron-icon></paper-button>`;
                                            }
                                            return buttons;
                                        }
                                        return '';
                                    }
                                }
                            ]
                        }
                    };
                }
                ready() {
                    super.ready();
                    this.$.grid.context = this;
                }
                handleRouteParams(action, id) {
                    if (action) return;
                    if (this.$.grid) {

                        this.$.grid.deferAutoresize();

                        if (this.route.query.reload == 'yes') {
                            this.$.grid.load();
                        } else {
                            this.$.grid.deferAutoload();
                        }
                    }
                }
                handleResizing(width, height) {
                    this.$.grid && this.$.grid.resize();
                }
                __onAddTap() {
                    this.set('route.path', '/expense/expense/add');
                }
                __onEditTap(e) {
                    this.set('route.path', '/expense/expense/edit/' + e.data.id_exp);
                }
                __onDeleteTap(e) {
                    let data = e.data;
                    if (data.id_exp) {
                        this.confirm('Confirm', `Are you sure you want to delete ${data.exp_no} ?`).then(b => {
                            if (b) {
                                this.$.ajax.DELETE('/expense/' + data.id_exp).then(() => {
                                    this.$.grid.load();
                                });
                            }
                        });    
                    }
                    
                }
                __onViewTap(e) {
                    this.set('route.path', '/expense/expense/view/' + e.data.id_exp);
                }
                __onJournalTap(e) {
                    this.set('route.path', '/expense/expense/journal/' + e.data.id_exp);
                }
                __onSubmitTap(e) {
                    this.confirm('Confirm', `Are you sure you want to submit ${e.data.exp_no} ?`).then(b => {
                        if (b) {
                            this.$.ajax.POST('/expense/' + e.data.id_exp + '/submit').then(() => {
                                this.$.grid.load();
                            });
                        }
                    });   
                }
            }
            customElements.define(ExpenseListPage.is, ExpenseListPage);
        }
    </script>
</dom-module>